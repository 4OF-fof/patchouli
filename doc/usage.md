# Patchouli使用ガイド

## はじめに

Patchouliはファイルサーバーのコンテンツを統合されたナレッジベースとして管理・運用するRustコアサーバーがAPIを提供し、クライアントモジュールがそれを消費するクライアント・サーバーアーキテクチャを使用しています。

## コアサーバーの使用

### サーバー起動
```bash
cd core/
cargo run
```

### APIエンドポイント
コアサーバーはクライアントモジュールが消費するHTTPエンドポイントを公開します。

**主要な機能:**
- ナレッジベース管理（統合された知識体系の構築・維持）
- ファイルアップロード・ダウンロード（メインコンテンツ）
- ファイル管理（一覧、削除、移動）
- コンテンツキュレーション（SQLiteでメタデータ、タグ付け、分類管理）
- インテリジェント検索（SQLite FTSによる全文検索、セマンティック検索、コンテキスト検索）
- ナレッジグラフ管理（SQLiteでコンテンツ間の関係性構築・可視化）
- ユーザー認証・認可

具体的なエンドポイントのドキュメントは実装後に利用可能になります。

## クライアントモジュールの使用

### Discordボット (discord/)
Discordボットモジュールはコアサーバーに接続してDiscord固有の機能を提供します。

**セットアップ:**
1. Discordボットトークンを設定
2. コアサーバーエンドポイントURLを設定
3. Discordボットクライアントを起動

**統合パターン:**
- coreサーバーAPIにHTTPリクエストを送信
- Discord固有のイベントとコマンドを処理
- DiscordインタラクションをコアAPI呼び出しに変換

### MCPモジュール (mcp/)
Model Context Protocolモジュールはコアサーバーを通じてAIモデル統合を提供します。

**セットアップ:**
1. MCPプロトコル設定を構成
2. コアサーバーエンドポイントURLを設定
3. MCPサービスを起動

**統合パターン:**
- MCPプロトコル仕様を実装
- coreサーバーAPIを通じてリクエストをルーティング
- AIモデルのコンテキストと状態を管理

## 開発ワークフロー

### 新しいモジュールの追加
1. 新しいモジュールディレクトリを作成
2. コアAPIと通信するHTTPクライアントを実装
3. モジュール固有の機能を追加
4. coreサーバーへの接続を設定

### API統合のベストプラクティス
1. **エラーハンドリング**: API呼び出しに適切なリトライロジックを実装
2. **設定**: サーバーエンドポイントに環境変数を使用
3. **認証**: 適切な認証ヘッダーを含める
4. **レート制限**: APIレート制限を尊重
5. **ログ**: デバッグのためAPIインタラクションをログ出力

### テスト
- **ユニットテスト**: モジュールロジックを独立してテスト
- **統合テスト**: コアサーバーとのAPI通信をテスト
- **エンドツーエンドテスト**: モジュール間の完全なワークフローをテスト

## 設定

### 環境変数
- `PATCHOULI_SERVER_URL`: コアサーバーエンドポイント (デフォルト: http://localhost:8080)
- `PATCHOULI_API_KEY`: API アクセス用の認証キー
- 必要に応じてモジュール固有の設定変数

### 設定ファイル
各モジュールは環境固有の設定のための設定ファイルをサポートする必要があります。

## デプロイ

### 開発環境
1. coreサーバーを起動
2. 必要に応じて個別のクライアントモジュールを起動
3. ローカルエンドポイントと認証情報を設定

### 本番環境
1. coreサーバーをデプロイ
2. 本番サーバーエンドポイントでクライアントモジュールをデプロイ
3. 適切な認証と監視を設定