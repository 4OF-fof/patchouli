# Patchouli使用ガイド

## はじめに

Patchouliはファイルサーバーのコンテンツを統合されたナレッジベースとして管理・運用するRustコアサーバーがAPIを提供し、クライアントモジュールがそれを消費するクライアント・サーバーアーキテクチャを使用しています。

## コアサーバーの使用

### サーバー起動
```bash
cd core/
cargo run
```

### APIエンドポイント
コアサーバーはクライアントモジュールが消費するHTTPエンドポイントを公開します。

**主要な機能:**
- ナレッジベース管理（統合された知識体系の構築・維持）
- ファイルアップロード・ダウンロード（メインコンテンツ）
- ファイル管理（一覧、削除、移動）
- コンテンツキュレーション（SQLiteでメタデータ、タグ付け、分類管理）
- インテリジェント検索（SQLite FTSによる全文検索、セマンティック検索、コンテキスト検索）
- ナレッジグラフ管理（SQLiteでコンテンツ間の関係性構築・可視化）
- **Google OAuth 2.0認証システム**
  - ブラウザベース認証フロー
  - セッション管理とアクセス制御
  - 保護されたリソースへのアクセス

**認証エンドポイント:**
- `GET /`: ホームページ（ログインリンク表示）
- `GET /login`: Google OAuth認証開始
- `GET /login/api`: API認証用トークン生成とログインURL取得
- `GET /callback`: OAuth認証コールバック（ブラウザ用）
- `GET /auth/status/:token`: 認証状態ポーリング（API用）
- `GET /protected`: 認証済みユーザー向け保護されたコンテンツ
- `GET /logout`: ログアウト

具体的なエンドポイントのドキュメントは実装後に利用可能になります。

## クライアントモジュールの使用

### Webフロントエンド (frontend/)
ReactベースのWebアプリケーションでPatchouliの機能にアクセスします。

**セットアップ:**
```bash
cd frontend/
pnpm install
pnpm run dev
```

**利用可能な機能:**
- Google OAuth 2.0によるログイン
- 保護されたコンテンツへのアクセス
- セッション管理とログアウト
- レスポンシブなWebUI

**アクセス方法:**
1. ブラウザで http://localhost:3000 にアクセス
2. 「Googleでログイン」をクリック
3. Google OAuth認証を完了
4. ダッシュボードで保護されたコンテンツを表示

**統合パターン:**
- Viteプロキシ経由でcoreサーバーAPIにアクセス
- React Routerによるクライアントサイドルーティング
- ローカルストレージによるセッション永続化
- Panda CSSによるモダンなUI実装

### Discordボット (discord/)
Discordボットモジュールはコアサーバーに接続してDiscord固有の機能を提供します。

**セットアップ:**
```bash
cd discord/
pnpm install
# 環境変数を設定
# DISCORD_BOT_TOKEN=your_discord_bot_token
# DISCORD_CLIENT_ID=your_discord_client_id
pnpm run dev
```

**利用可能なコマンド:**
- `/authenticate`: Google OAuth認証を開始
- `/checkauth`: 認証状態を確認（オプション）
- `/getcontent`: 認証後に保護されたコンテンツを取得
- `/status`: Patchouliサーバーの接続状態を確認
- `/logout`: セッションをクリア

**認証フロー:**
1. `/authenticate` コマンドを実行
2. 提供されたURLでブラウザ認証を完了
3. 認証完了時に自動でセッションが保存される
4. `/getcontent` で即座にコンテンツアクセス可能（checkauthは不要）

**統合パターン:**
- coreサーバーAPIにHTTPリクエストを送信
- Discord固有のイベントとコマンドを処理
- DiscordインタラクションをコアAPI呼び出しに変換
- **自動セッション管理**: 認証完了時の自動セッションID保存
- **Express通知サーバー**: OAuth callback通知の受信とリアルタイム更新

### MCPモジュール (mcp/)
Model Context Protocolモジュールはコアサーバーを通じてAIモデル統合を提供します。

**セットアップ:**
1. MCPプロトコル設定を構成
2. コアサーバーエンドポイントURLを設定
3. MCPサービスを起動

**利用可能なツール:**
- `authenticate`: ブラウザベース認証でセッションIDを取得
- `get_protected_content`: 認証済みユーザー向けの保護されたコンテンツ取得

**認証フロー:**
1. `authenticate`ツールを実行
2. 自動でブラウザが開きGoogle OAuth認証を実行
3. 認証完了後、セッションIDを自動取得
4. `get_protected_content`でセッションIDを使用してコンテンツアクセス

**統合パターン:**
- MCPプロトコル仕様を実装
- coreサーバーAPIを通じてリクエストをルーティング
- AIモデルのコンテキストと状態を管理
- **ブラウザ自動化による認証システム**（openパッケージ使用）
- 認証状態のポーリングとセッション管理

## 開発ワークフロー

### 新しいモジュールの追加
1. 新しいモジュールディレクトリを作成
2. コアAPIと通信するHTTPクライアントを実装
3. モジュール固有の機能を追加
4. coreサーバーへの接続を設定

### API統合のベストプラクティス
1. **エラーハンドリング**: API呼び出しに適切なリトライロジックを実装
2. **設定**: サーバーエンドポイントに環境変数を使用
3. **認証**: 適切な認証ヘッダーを含める
4. **レート制限**: APIレート制限を尊重
5. **ログ**: デバッグのためAPIインタラクションをログ出力

### テスト
- **ユニットテスト**: モジュールロジックを独立してテスト
- **統合テスト**: コアサーバーとのAPI通信をテスト
- **エンドツーエンドテスト**: モジュール間の完全なワークフローをテスト

## 設定

### 環境変数

**コアサーバー:**
- `GOOGLE_CLIENT_ID`: Google OAuth 2.0 クライアントID（必須）
- `GOOGLE_CLIENT_SECRET`: Google OAuth 2.0 クライアントシークレット（必須）
- `REDIRECT_URL`: OAuth リダイレクトURL（デフォルト: http://localhost:8080/callback）

**クライアントモジュール:**
- `PATCHOULI_SERVER_URL`: コアサーバーエンドポイント (デフォルト: http://localhost:8080)

**Discordボット:**
- `DISCORD_BOT_TOKEN`: Discord ボットトークン（必須）
- `DISCORD_CLIENT_ID`: Discord クライアントID（必須）
- `DISCORD_BOT_PORT`: 通知サーバーポート（デフォルト: 3001）
- `DISCORD_BOT_URL`: 通知サーバーURL（デフォルト: http://localhost:3001）

**その他:**
- 必要に応じてモジュール固有の設定変数

### 設定ファイル
各モジュールは環境固有の設定のための設定ファイルをサポートする必要があります。

## デプロイ

### 開発環境
1. coreサーバーを起動
2. 必要に応じて個別のクライアントモジュールを起動
3. ローカルエンドポイントと認証情報を設定

### 本番環境
1. coreサーバーをデプロイ
2. 本番サーバーエンドポイントでクライアントモジュールをデプロイ
3. 適切な認証と監視を設定