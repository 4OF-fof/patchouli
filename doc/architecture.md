# Patchouliアーキテクチャ

## 概要

Patchouliはファイルサーバーのコンテンツを1つのナレッジベースとして管理・運用する、HTTP APIを通じてコア機能を提供する中央のRustサーバーを持つマイクロサービスアーキテクチャとして設計されています。

## コアコンポーネント

### core/ (コアサーバー)
- **技術**: Rust + Axum + SQLite
- **役割**: コア機能を提供する中央APIサーバー
- **フレームワーク**: Axumを使用したWebサーバー実装
- **データストレージ**: 
  - **メインコンテンツ**: ファイルサーバー内のファイル
  - **補助データベース**: SQLite（メタデータ、インデックス、関係性情報）
- **責務**:
  - HTTP APIエンドポイント管理
  - ナレッジベース管理（統合された知識体系の構築・維持）
  - ファイルサーバー機能（ファイルアップロード、ダウンロード、管理）
  - コンテンツキュレーション（メタデータ、タグ付け、分類、関連性分析）
  - インテリジェント検索機能（全文検索、セマンティック検索、コンテキスト検索）
  - ナレッジグラフ構築（コンテンツ間の関係性管理）
  - コアビジネスロジック
  - データ永続化と管理（ファイルストレージ + SQLiteデータベース）
  - **Google OAuth 2.0認証システム** （Google OAuth 2.0を使用したユーザー認証とセッション管理）
  - レート制限とリクエスト処理

### クライアントモジュール

#### frontend/
- **役割**: Webフロントエンドアプリケーション
- **技術**: Vite + React 19 + TypeScript + Panda CSS
- **統合**: coreサーバーAPIを消費（プロキシ経由）
- **機能**: 
  - **レスポンシブWebUI**（Panda CSSによるモダンなデザインシステム）
  - **Google OAuth 2.0統合**（シームレスな認証フロー）
  - **セッション管理**（ローカルストレージベースの永続化）
  - **保護されたルート**（認証ベースのアクセス制御）
  - **リアルタイムフィードバック**（APIエラーハンドリングとローディング状態）

#### discord/
- **役割**: Discordボットクライアント
- **技術**: TypeScript + discord.js + Express
- **統合**: coreサーバーAPIを消費
- **機能**: 
  - **Discordスラッシュコマンド**（認証、コンテンツ取得、ステータス確認）
  - **Google OAuth 2.0統合**（Discord用カスタム認証フロー）
  - **自動セッション管理**（認証完了時の自動セッションID保存）
  - **認証完了通知**（リアルタイム認証状態フィードバック）
  - **Express通知サーバー**（OAuth callback通知の受信）

#### mcp/
- **役割**: Model Context Protocol実装
- **技術**: TypeScript + MCP TypeScript SDK + open（ブラウザ自動化）
- **統合**: coreサーバーAPIを消費
- **機能**: 
  - MCPプロトコル処理とAIモデル統合
  - **ブラウザベース認証システム**（自動ブラウザ起動とOAuth認証）
  - 認証状態ポーリングとセッション管理
  - 保護されたコンテンツへのアクセス

## 通信フロー

```
┌─────────────────┐    HTTP API    ┌──────────────┐
│    frontend     │◄──────────────►│              │
│ (React + Vite)  │   (プロキシ経由)  │              │
└─────────────────┘                │              │
                                   │  patchouli   │
┌─────────────────┐    HTTP API    │ (Rust Core)  │
│     discord     │◄──────────────►│              │
└─────────────────┘                │              │
                                   │              │
┌─────────────────┐    HTTP API    │              │
│      mcp        │◄──────────────►│              │
└─────────────────┘                └──────────────┘
```

## 開発原則

1. **API ファースト設計**: コアサーバーが明確なHTTP APIコントラクトを定義
2. **モジュール独立性**: 各クライアントモジュールは独立して開発・デプロイ可能
3. **言語柔軟性**: クライアントモジュールは任意の言語/フレームワークを使用可能
4. **スケーラビリティ**: 需要に応じてコンポーネントを独立してスケール可能
5. **保守性**: コアロジックとモジュール固有実装の明確な関心の分離

## 技術的特徴

### Axumフレームワーク
- **非同期処理**: Tokioベースの高性能非同期Webフレームワーク
- **型安全性**: Rustの型システムによる安全なAPIルーティング
- **ミドルウェアサポート**: 認証、ログ、エラーハンドリングなどの横断的関心事を処理
- **JSON/REST API**: 標準的なREST APIエンドポイントをサポート
- **WebSocket対応**: リアルタイム通信が必要な場合のWebSocketサポート

### データストレージアーキテクチャ
- **ハイブリッドストレージ**: ファイルシステム + SQLiteデータベース
- **メインコンテンツ**: ファイルサーバー内に実際のファイルを保存
- **メタデータ管理**: SQLiteでファイル情報、タグ、関係性を管理
- **検索インデックス**: SQLiteのFTSを活用した高速全文検索
- **軽量設計**: サーバーレス環境に適したSQLiteベースの軽量データベース
- **ACID準拠**: SQLiteによるトランザクション保証

## 利点

- **モジュラリティ**: 既存モジュールに影響を与えずに新しい統合を簡単に追加
- **パフォーマンス**: Rust + Axumの組み合わせによる高性能なAPI処理
- **型安全性**: コンパイル時の型チェックによる安全なAPI実装
- **柔軟性**: クライアントモジュールが適切な技術スタックを選択可能
- **テスト**: 各コンポーネントを独立してテスト可能
- **デプロイ**: コンポーネントの独立したデプロイとスケーリング